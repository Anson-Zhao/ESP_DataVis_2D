<html>
<head>
    <style>
        #gx, #gy, #gz {
        width:320px; height:320px;
        display: inline-block;
        margin: 1em;
    }</style>
    <script type="text/javascript"
            src="Library/dygraph/dygraph.js"></script>
    <link rel="stylesheet" src="Library/dygraph/dygraph.css" />
    <script src='Library/jquery-3-4-1.min.js'></script>
    <script src="Library/justgage-1.2.2/raphael-2.1.4.min.js"></script>
    <script src="Library/justgage-1.2.2/justgage.js"></script>
</head>
<body>
<h2>The gauges represent live X-Y-Z data from the ESP-1 Station in Middletown, NY with a 2-minute delay</h2>
<div id="gx"></div>
<div id="gy"></div>
<div id="gz"></div>

<h2>Live Chart</h2>
<h2>The charts represent 2 minutes of live data from the ESP-1 Station, with a 2-minute delay</h2>

<h3>X</h3>
<div id="graphx"></div>
<h3>Y</h3>
<div id="graphy"></div>
<h3>Z</h3>
<div id="graphz"></div>


The Modal
<div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <h2>ESP Data <br><br><div id = location_info></div></h2>
        </div><br>
        <div class="modal-body">
            <p class= "para">Here is the info about the earthquake, the values of the axis are on the labels.<br><br>Data updates every 5 seconds, although there is a delay of 1 to 3 minutes.</p>
            <img src="3D_Vector_Arrow.png" alt = "ESP Vector" id = "myImg">
        <div id="233"></div>
        </div><br>
    </div>
</div>








<button onclick = "query()" id = "fakeBu"></button>
<script type="text/javascript">
</script>
<script>
    var gx,gy,gz;
    gx = new JustGage({
        id: "gx",
        title: "X",
        customSectors: [{ color : "#66ccff", lo : 0, hi : 20 }, { color: "#ff0000", lo: 20, hi: 100 }],
        max:400000,
        min:0,
        label: "x average value",
        levelColorsGradient: true

    });
    gx.refresh(0);
    gy = new JustGage({
        id: "gy",
        title: "Y",
        customSectors: [{ color : "#66ccff", lo : 0, hi : 20 }, { color: "#ff0000", lo: 20, hi: 100 }],
        max:400000,
        min:0,
        label: "y average value",
        levelColorsGradient: false

    });
    gy.refresh(0);
    gz = new JustGage({
        id: "gz",
        title: "Z",
        customSectors: [{ color : "#66ccff", lo : 0, hi : 20 }, { color: "#ff0000", lo: 20, hi: 100 }],
        max:400000,
        min:0,
        label: "z average value",
        levelColorsGradient: false

    });
    gz.refresh(0);

    var xa,ya,za;

    function avg(res,len){
        var arr = res.slice(Math.max(res.length - len, 1));
        xa = ya = za = 0;
        for(var i = 0; i<arr.length; i++){
            xa += arr[i].mean;
            ya += arr[i].mean_1;
            za += arr[i].mean_2
        }
        xa = xa/len;
        ya = ya/len;
        za = za/len;
    }

    function query() {
        $.ajax({
            url: "https://cors.aworldbridgelabs.com:9084/http://mockup.esp.aworldbridgelabs.com:8008/query",
            method: "get",
            //Says success isn't used but it is
            success: function(res){
                var x_arr = [];
                var y_arr = [];
                var z_arr = [];

                res.forEach(function(el,i) {
                        x_arr[i] = [new Date(el.time), el.mean];
                        y_arr[i] = [new Date(el.time), el.mean_1];
                        z_arr[i] = [new Date(el.time), el.mean_2];
                    }
                );

                avg(res,5);
                Z = new Dygraph(

                    // containing div
                    document.getElementById("graphz"),

                    // CSV or path to a CSV file.
                    z_arr,
                    {
                        labels: [ "time", "Z" ]
                    }

                );
                Y = new Dygraph(

                    // containing div
                    document.getElementById("graphy"),

                    // CSV or path to a CSV file.
                    y_arr,
                {
                    labels: [ "time", "Y" ]
                }

                );
                X = new Dygraph(

                    // containing div
                    document.getElementById("graphx"),

                    // CSV or path to a CSV file.
                    x_arr,
                    {
                        labels: [ "time", "X" ]
                    }
                );
                gx.refresh(Math.abs(xa));
                gy.refresh(Math.abs(ya));
                gz.refresh(Math.abs(za));
                D3Chart();
            }
        });
    }
</script>

<script>

var D3Chart = function() {
    $.ajax( {
        data : {
            key1: xa,
            key2: ya,
            key3: za,
        },
        type : 'GET',
        url : 'http://localhost:7000/process',
        success: function(res){
            console.log(res);
            $("#myImg").remove();
            $("<img>")
                .attr("src","3D_Vector_Arrow.png?"+ (new Date).getTime())
                .attr("id","myImg")
                .attr("alt","ESP Vector")
                .appendTo("#233");
        }
    });
};
</script>
<script>
    setInterval(function () {document.getElementById("fakeBu").click();}, 5000);
</script>
</body>
</html>